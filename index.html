<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="./assets/css/reset.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
        crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Libre+Baskerville" rel="stylesheet">
    <link href="./assets/css/style.css" rel="stylesheet">
    <title>Train Schedule</title>
</head>

<body>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <div class="row">
                <div class="col-sm">
                    <h1 class="display-4">All Aboard!</h1>
                    <h4>The following is the train schedule.</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="jumbotron jumbotron-fluid">
        <div class="container1">
            <div class="row">
                <div class="col-sm">
                    <h3>Current Train Schedule</h3>
                </div>
            </div>
            <table class="table table-sm table-hover table-striped table-borderless table-hover">
                <thead>
                    <tr>
                        <th>
                            <h4 id="addName">Train Name</h4>
                        </th>
                        <th>
                            <h4 id="addDestination">Destination</h4>
                        </th>
                        <th>
                            <h4 id="addFrequency">Frequency</h4>
                        </th>
                        <th>
                            <h4 id="addTime">Next Arrival Time</h4>
                        </th>
                        <th>
                            <h4 id="addMinutes">Minutes Away</h4>
                        </th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <div class="row">
                <div class="col-sm">
                    <h3>Add a Train to the Schedule</h3>
                </div>
            </div>
            <form>
                <div class="row">
                    <div class="col-sm form-group">
                        <label for="exampleTrainName">
                            <h5>Train Name</h5>
                        </label>
                        <input type="name" class="form-control" id="nameTrain" placeholder="Enter Train Name">
                    </div>
                    <div class="col-sm form-group">
                        <label for="exampleTrainDestination">
                            <h5>Destination</h5>
                        </label>
                        <input type="destination" class="form-control" id="destinationTrain" placeholder="Enter Train Destination">
                    </div>
                </div>
            </form>
            <form>
                <div class="row">
                    <div class="col-sm form-group">
                        <label for="exampleTrainTime">
                            <h5>First Train Time</h5>
                            <p>Example: 8:30 AM</p>
                        </label>
                        <input type="first time" class="form-control" id="firstTimeTrain" placeholder="Enter the Time of the First Train">
                    </div>
                    <div class="col-sm form-group">
                        <label for="exampleTrainFrequency">
                            <h5>Frequency (minutes)</h5>
                            <p>Example: 20</p>
                        </label>
                        <input type="frequency" class="form-control" id="frequencyTrain" placeholder="Enter the Frequency of the Train">
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm form-group">
                        <button id="submit" type="button" class="btn btn-light">
                            <h5>Submit</h5>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>
    <script>
        // adding firebase
        var config = {
            apiKey: "AIzaSyDniQ-KTm3I1YetRqZyvEd1u1uSu8q6ta4",
            authDomain: "trainschedule-12f43.firebaseapp.com",
            databaseURL: "https://trainschedule-12f43.firebaseio.com",
            projectId: "trainschedule-12f43",
            storageBucket: "",
            messagingSenderId: "1048471152863"
        };
        firebase.initializeApp(config);

        // set up global vars
        var trainName;
        var trainDestination;
        var startTime;
        var trainFrequency;
        var trainMinutesAway;
        // the time NOW
        var momentTime = moment();
        var dbObj;
        var formNextTrain;
        var nextTrain;


        // setInterval(calculateMinAwayNext, 1000);
        // function calculateMinAwayNext() {
        //     var randomFormat = "hh:mm A";
        //     var convertedTime = moment(trainTime, randomFormat);
        //     var formtrainFrequency = parseInt(trainFrequency);
        //     // (convertedDate.diff(newDate, "days"))
        //     var diff = momentTime.diff(convertedTime, "minutes") % formtrainFrequency;
        //     trainMinutesAway = formtrainFrequency - diff;
        //     nextTrain = moment().add("minutes", trainMinutesAway);
        //     formNextTrain = nextTrain.format(randomFormat);
        // }



        var database = firebase.database();

        database.ref().on('child_added', function (db) {
            dbObj = db.val();
            console.log("user's input", dbObj.firsttime);

            // create moment.js object for train time and frequency
            startTrain = moment(dbObj.firsttime, "HH:mm A");
            console.log("start time: ", startTrain.format("HH:mm A"));

            trainFrequency = parseInt(dbObj.frequency);
            console.log("frequency", trainFrequency);

            trainMinutesAway = trainFrequency - momentTime.diff(startTrain, "minutes") % trainFrequency;
            console.log("minutes away", trainMinutesAway);

            nextTrain = moment().add(trainMinutesAway,"minutes");
            formNextTrain=nextTrain.format("hh:mm A");
            console.log("arrival", formNextTrain);

            // //---------------------------------------------//
        
            var newRow = $("<tr>");
            newRow.append($("<td>" + dbObj.name + "</td>"));
            newRow.append($("<td>" + dbObj.destination + "</td>"));
            newRow.append($("<td>" + dbObj.frequency + "</td>"));
            newRow.append($("<td>" + formNextTrain + "</td>"));
            newRow.append($("<td>" + trainMinutesAway + "</td>"));
            $("tbody").append(newRow);
        },
            function (e) {
                console.log(e);
            }
        );

        $("#submit").on("click", function () {
            event.preventDefault();
            trainName = $("#nameTrain").val().trim();
            trainDestination = $("#destinationTrain").val().trim();
            startTime = $("#firstTimeTrain").val().trim();
            trainFrequency = $("#frequencyTrain").val().trim();
            // push info to database
            database.ref().push({
                name: trainName,
                destination: trainDestination,
                firsttime: startTime,
                frequency: trainFrequency,
                nexttrain: formNextTrain,
                minutesaway: trainMinutesAway,
            });

        })

    </script>
</body>

</html>